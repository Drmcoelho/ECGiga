
# Gemini Project Context: ECGiga

## 1. Project Overview

**ECGiga** is an open-source, interactive, and clinical electrocardiography (ECG) course designed for medical professionals. The project aims to provide a robust learning platform with a didactic CLI, a dynamic web application, AI-assisted features, and a comprehensive quiz bank.

- **Mission:** To build the largest and most comprehensive open-source ECG course.
- **Target Audience:** Medical students and healthcare professionals seeking to deepen their ECG interpretation skills.
- **Core Features:**
    - **Interactive Learning:** Combines a CLI, web app, and Jupyter notebooks for a multi-faceted learning experience.
    - **Extensive Quiz Bank:** Hundreds of multiple-choice questions with detailed clinical explanations, validated against a JSON schema.
    - **Computer Vision (CV) Analysis:** Tools to process ECG images, including deskewing, normalization, layout detection, and feature extraction (R-peaks, intervals).
    - **AI-Assisted Lauding:** Future integration with large language models (LLMs) to provide preliminary ECG reports and guided tutoring.
    - **Physiological Simulations:** Interactive simulations to demonstrate the impact of ionic changes on ECG waveforms.

## 2. Core Modules & Key Files

### 2.1. Command-Line Interface (`cli_app/`)

The CLI, built with `Typer` and `Rich`, provides a powerful and user-friendly interface for interacting with the course content.

- **`cli_app/ecgcourse/cli.py`**: The main entry point for the CLI application.
- **Key Commands:**
    - `ecgcourse quiz run <file>`: Runs a quiz from a JSON file.
    - `ecgcourse quiz validate <file>`: Validates a quiz file against the schema.
    - `ecgcourse quiz build`: Generates a quiz from a laudo file.
    - `ecgcourse analyze values <options>`: Analyzes structured ECG data (e.g., PR, QRS, QT intervals).
    - `ecgcourse ingest image <file>`: Ingests an ECG image and generates a detailed report.
    - `ecgcourse cv <subcommand>`: Provides access to various computer vision tools for ECG image analysis.

### 2.2. Web Application (`web_app/`)

The web application, built with `Dash`, provides an interactive and visual platform for learning.

- **`web_app/dash_app/app.py`**: The main entry point for the Dash application.
- **Features:**
    - **ECG Viewer:** Displays 12-lead ECGs with zooming and panning capabilities.
    - **Interactive Calculators:** Tools for calculating QTc and other ECG parameters.
    - **Image Upload:** Allows users to upload their own ECG images for analysis.
    - **Simulation Sliders:** Interactive sliders to visualize the effects of ion changes (K+, Ca2+, Na+) on ECG waveforms.

### 2.3. Computer Vision (`cv/`)

The `cv/` directory contains a suite of tools for ECG image processing and analysis.

- **`deskew.py`**: Corrects for skewed ECG images.
- **`normalize.py`**: Normalizes the scale of ECG images.
- **`grid_detect.py`**: Detects the grid lines on an ECG.
- **`segmentation.py` & `segmentation_ext.py`**: Segments the ECG into individual leads and layouts.
- **`lead_ocr.py`**: Performs OCR to identify the lead labels (I, II, III, aVR, etc.).
- **`rpeaks_from_image.py` & `rpeaks_robust.py`**: Detects R-peaks from the ECG image.
- **`intervals.py`**: Calculates ECG intervals (PR, QRS, QT, QTc).

### 2.4. Quiz Engine (`quiz/`)

The quiz engine is a core component of the learning platform, providing a large bank of validated multiple-choice questions.

- **`quiz/bank/`**: Contains the JSON files for the quiz questions.
- **`quiz/schema/mcq.schema.json`**: The JSON schema used to validate the quiz files.
- **`quiz/generate_quiz.py`**: A script to generate new quizzes from existing data.

### 2.5. Notebooks (`notebooks/`)

The `notebooks/` directory contains a collection of Jupyter notebooks that provide supplementary educational content and practical examples.

- **Topics Covered:** QTc formulas, cardiac axis, R-peak detection, ion effects, artifact filtering, image preprocessing, and more.

## 3. Data Structures & Schemas

- **`quiz/schema/mcq.schema.json`**: Defines the structure for multiple-choice questions, ensuring consistency and quality. Each question includes an ID, topic, difficulty, stem, options, answer index, and a detailed explanation.
- **`reporting/schema/report.schema.json`**: Defines the structure for the standardized ECG reports generated by the `ingest image` command. This schema has evolved through several versions (v0.2, v0.3, v0.4).
- **`assets/manifest/`**: Contains JSONL and CSV files that catalog ECG images and datasets from open-source repositories like PhysioNet and Wikimedia.

## 4. Development Workflow

### 4.1. Setup

1.  **Clone the repository:**
    ```bash
    git clone <repository_url> ecg-megaprojeto
    cd ecg-megaprojeto
    ```
2.  **Create and activate a virtual environment:**
    ```bash
    python3 -m venv .venv
    source .venv/bin/activate
    ```
3.  **Install dependencies:**
    ```bash
    pip install -r requirements.txt
    ```

### 4.2. Running the Applications

-   **CLI:**
    ```bash
    python -m ecgcourse --help
    ```
-   **Web App (Dash):**
    ```bash
    python web_app/dash_app/app.py
    ```

### 4.3. Contributing

-   **Code Style:** The project uses `Black` for code formatting and `Ruff` for linting.
-   **Quizzes:** Contributions to the quiz bank are welcome. Ensure that new quiz files are validated against the `mcq.schema.json` schema.
-   **Roadmap:** The project roadmap is detailed in `docs/roadmap.md`.

## 5. Project Roadmap (High-Level)

-   **p0-p7 (Completed):** Foundational work, including the project skeleton, CLI and web app stubs, quiz engine, and initial CV tools.
-   **Future Work (p8-p30):**
    -   Expand the quiz bank and educational content.
    -   Enhance the CV capabilities for more accurate and robust ECG analysis.
    -   Integrate LLMs for AI-assisted lauding and tutoring.
    -   Develop advanced interactive features in the web application.
    -   Package the application for desktop and mobile use.
