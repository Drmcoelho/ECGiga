<!doctype html>
<meta charset="utf-8">
<title>ECGiga — ST–T Lab</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#fff;margin:0}
header{background:#111;color:#fff;padding:14px 18px}
main{display:grid;grid-template-columns:1fr 320px;gap:12px;padding:12px}
.panel{border:1px solid #e5e7eb;border-radius:10px;padding:10px}
canvas{width:100%;height:200px;border:1px solid #e5e7eb;border-radius:10px}
.row{display:flex;gap:8px;align-items:center;margin:8px 0}
.badge{display:inline-block;background:#eef;border:1px solid #99c;border-radius:4px;padding:1px 6px;margin-left:6px;font-size:12px}
</style>
<header><h3>ST–T Lab — Íons & Isquemia</h3></header>
<main>
  <div class="panel">
    <canvas id="lead"></canvas>
    <div class="row"><small>Traçado sintético (lead II). Ajuste cenários e observe ST/T.</small></div>
  </div>
  <div class="panel">
    <div class="row"><label>Isquemia:</label>
      <select id="isc">
        <option value="none">Nenhuma</option>
        <option value="subendo">Subendocárdica</option>
        <option value="transmural">Transmural</option>
      </select>
    </div>
    <div class="row"><label>K⁺ sérico:</label><input id="k" type="range" min="2.0" max="7.5" step="0.1" value="4.0"><span id="kv" class="badge">4.0</span></div>
    <div class="row"><label>Freq. (bpm):</label><input id="hr" type="range" min="40" max="140" step="1" value="75"><span id="hrv" class="badge">75</span></div>
    <div class="row"><small>HiperK⁺: T apiculada / encurtamento QT; HipoK⁺: T achatada + U.</small></div>
  </div>
</main>
<script>
const cvs = document.getElementById('lead'); cvs.width=800; cvs.height=200; const ctx=cvs.getContext('2d');
const kv = document.getElementById('kv'), hrv=document.getElementById('hrv');
document.getElementById('k').oninput=(e)=>kv.textContent=parseFloat(e.target.value).toFixed(1);
document.getElementById('hr').oninput=(e)=>hrv.textContent=parseInt(e.target.value);
let t=0;
function synth(ecgIdx, bpm, k, isc){
  // base senoidal + picos sintéticos para P, QRS, T
  const rr = 60.0/bpm; // s
  const w = 2*Math.PI / (rr*60.0); // rad/s (escala didática)
  const base = Math.sin(ecgIdx*w)*0.02;
  // QRS
  const qrs = Math.exp(-Math.pow((ecgIdx%rr-0.05)/0.015,2))*1.2;
  // P
  const p = Math.exp(-Math.pow((ecgIdx%rr-0.2)/0.03,2))*0.2;
  // T dependente de K
  let tpe = 0.45 + Math.max(0, (k-4.0))*0.25; // apex mais alto em hiperK⁺
  if(k<3.4) tpe = 0.25; // hipoK: T pequena
  const T = Math.exp(-Math.pow((ecgIdx%rr-0.3)/0.06,2))*tpe;
  // U em hipoK
  const U = k<3.4 ? Math.exp(-Math.pow((ecgIdx%rr-0.42)/0.04,2))*0.15 : 0;
  // ST shift por isquemia
  let ST = 0;
  if(isc==='subendo') ST = -0.15; else if(isc==='transmural') ST = 0.25;
  return base + p + (qrs - 0.4) + (T + U) + ST;
}
const buf=[]; const buflen=800;
function draw(){
  const bpm = parseInt(document.getElementById('hr').value);
  const k = parseFloat(document.getElementById('k').value);
  const isc = document.getElementById('isc').value;
  buf.push(synth(t/120, bpm, k, isc)); if(buf.length>buflen) buf.shift();
  ctx.fillStyle="#fff"; ctx.fillRect(0,0,cvs.width,cvs.height);
  ctx.strokeStyle="#222"; ctx.strokeRect(0,0,cvs.width,cvs.height);
  ctx.beginPath(); ctx.strokeStyle="#000";
  for(let i=0;i<buf.length;i++){ const y=cvs.height/2 - buf[i]*90; if(i===0) ctx.moveTo(i,y); else ctx.lineTo(i,y); } ctx.stroke();
  t++;
  requestAnimationFrame(draw);
}
draw();
</script>
